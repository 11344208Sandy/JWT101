<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>留言板</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f4f4f9;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 10px;
        }

        .post-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

            button:hover {
                background: #005a9e;
            }

        .message-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 5px solid #0078d4;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }

        .msg-info {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .msg-content {
            line-height: 1.6;
        }

        .logout-btn {
            background: #d83b01;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>NET 程式設計期末專案:留言板</h2>
        <div>
            <span id="userInfo"></span>
            <button class="logout-btn" onclick="logout()">登出</button>
        </div>
    </div>

    <div class="post-box">
        <h3>撰寫新留言</h3>
        <input type="text" id="subject" placeholder="請輸入主題">
        <textarea id="content" rows="4" placeholder="請輸入留言內容"></textarea>
        <button onclick="AddMessage()">送出留言</button>
    </div>

    <div id="messageList">
        <p>留言載入中...</p>
    </div>

    <script>
    // 1. 檢查是否有 Token，沒有就踢回登入頁
    // 頁面載入時執行
        const token = localStorage.getItem("jwtToken"); // 從快取取得登入憑證
    if (!token) {
        alert("請先登入！");
        window.location.href = "Login.html"; // 請確保你的登入頁檔名正確
    }

    // 2. 頁面載入時自動讀取留言
    window.onload = loadMessages;
    // 從 API 抓取所有留言
    async function loadMessages() {
        try {
            const response = await fetch('/api/Message', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token // 將 JWT 放在 Header 進行驗證
                }
            });

            if (response.status === 401) {
                alert("登入逾時或無權限，請重新登入");
                logout();
                return;
            }

            const data = await response.json();
            displayMessages(data);
        } catch (err) {
            document.getElementById('messageList').innerHTML = "載入失敗：" + err;
        }
    }

    // 將留言陣列轉換成 HTML 顯示
    function displayMessages(messages) {
        const listEl = document.getElementById('messageList');

        if (!Array.isArray(messages)) {
            console.error("API 回傳格式錯誤：", messages);
            listEl.innerHTML = `<p style="color:red">載入失敗：伺服器回傳了非陣列資料 (${messages.message || '未知錯誤'})</p>`;
            return;
        }

        if (messages.length === 0) {
            listEl.innerHTML = "<p>目前尚無留言。</p>";
            return;
        }
        // 將資料物件轉成 JSON 字串並編碼，方便傳遞給詳情頁
        listEl.innerHTML = messages.map(m => `
    <div class="message-item"
            style="cursor: pointer; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;"
            onclick="viewDetail('${encodeURIComponent(JSON.stringify(m))}')">

        <div class="msg-info" style="color: #666; font-size: 0.9em;">
            <strong>${m.userID || m.UserID || '無Email資料'}</strong> 
            發表於 ${new Date(m.p_Date).toLocaleString()}
        </div>
        <h3 style="margin: 10px 0;">
            <a href="javascript:void(0)"
                onclick="goToDetail('${encodeURIComponent(JSON.stringify(m))}')" 
                style="color: #0078d4; text-decoration: none;">
                主題：${m.subject || m.Subject}
            </a>
        </h3>
            
        <div class="msg-content">
            ${(m.content || m.Content).substring(0, 50)}... 
            <br><span style="color: blue;">[閱讀全文]</span>
        </div>
    </div>
    `).join('');
    }

    // 點擊留言跳轉至詳細頁面
    function viewDetail(dataStr) {
        // 1. 先把資料解碼並存到瀏覽器快取
        localStorage.setItem('currentViewMessage', decodeURIComponent(dataStr));

        // 2. 執行跳轉（請確認你的檔案名稱真的是 MessageDetail.html）
        window.location.href = 'MessageDetail.html';
    }

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("userEmail");
        localStorage.removeItem("currentViewMessage"); // 清理快取
        window.location.href = "Login.html";
    }

    // 發送新留言至後端
    async function AddMessage() {
            const subject = document.getElementById('subject').value;
            const content = document.getElementById('content').value;

            if (!subject || !content) {
                alert("請填寫主題和內容");
                return;
            }

            const messageData = {
                subject: subject,
                content: content
            };

            console.log("正在發送留言資料：", messageData);

            const token = localStorage.getItem("jwtToken");
            if (!token) {
                alert("請先登入");
                window.location.href = "Login.html";
                return;
            }
            
            try {
                const response = await fetch('/api/Message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(messageData)
                });

                if (response.ok) {
                    alert("留言發布成功！");
                    // 清空輸入框
                    document.getElementById('subject').value = '';
                    document.getElementById('content').value = '';

                    // 重新讀取清單
                    loadMessages();
                } else {
                    // 如果報 400 錯誤，這裡會印出後端具體的錯誤原因
                    const errorData = await response.json();
                    console.error("錯誤詳情:", errorData);
                    alert("發布失敗：" + (errorData.message || "請檢查輸入格式"));
                }
            } catch (err) {
                alert("連線錯誤，請檢查後端是否啟動", err);
            }
    }
    </script>

</body>
</html>